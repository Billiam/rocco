<!DOCTYPE html>
<html>
<head>
  <title>rocco.rb</title>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
    <link rel="stylesheet" media="all" href="http://jashkenas.github.com/docco/resources/parallel/public/stylesheets/normalize.css">
    <link rel="stylesheet" media="all" href="http://jashkenas.github.com/docco/resources/parallel/docco.css">
    <link rel="stylesheet" media="all" href="http://billiam.github.com/rocco/resources/highlight.css">
</head>
<body>
  <div id='container'>
    <div id="background"></div>
      <ul id="jump_to">
      <li>
        <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
        <a class="small" href="javascript:void(0);">+</a>
        <div id="jump_wrapper">
          <div id="jump_page">
            <div id="jump_sources" class="jump_page">
                <a class="source" href="rocco.html">rocco.rb</a>
                <a class="source" href="rocco/comment_styles.html">comment_styles.rb</a>
                <a class="source" href="rocco/layout.html">layout.rb</a>
                <a class="source" href="rocco/tasks.html">tasks.rb</a>
            </div>
            <div id="jump_results" class="jump_page"></div>
          </div>
        </div>
      </li>
    </ul>
  <ul class="sections">
    <li id="title">
      <div class="annotation">
        <h1>rocco.rb</h1>
      </div>
    </li>
    <li id="section-1">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p><strong>Rocco</strong> is a Ruby port of <a href="http://jashkenas.github.com/docco/">Docco</a>, the quick-and-dirty,
hundred-line-long, literate-programming-style documentation generator.</p>

<p>Rocco reads Ruby source files and produces annotated source documentation
in HTML format. Comments are formatted with <a href="http://daringfireball.net/projects/markdown/">Markdown</a> and presented
alongside syntax highlighted code so as to give an annotation effect.
This page is the result of running Rocco against <a href="http://github.com/rtomayko/rocco/blob/master/lib/rocco.rb#commit">its own source file</a>.</p>

<p>Most of this was written while waiting for <a href="http://nodejs.org/">node.js</a> to build (so I
could use Docco!). Docco&#39;s gorgeous HTML and CSS are taken verbatim.
The main difference is that Rocco is written in Ruby instead of
<a href="http://coffeescript.org/">CoffeeScript</a> and may be a bit easier to obtain and install in
existing Ruby environments or where node doesn&#39;t run yet.</p>

<p>Install Rocco with Rubygems:</p>

<pre><code>gem install rocco
</code></pre>

<p>Once installed, the <code>rocco</code> command can be used to generate documentation
for a set of Ruby source files:</p>

<pre><code>rocco lib/*.rb
</code></pre>

<p>The HTML files are written to the current working directory.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre></pre></div>
      </div>
    </li>
    <li id="section-Prerequisites">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Prerequisites">&#182;</a>
        </div>
        <h3>Prerequisites</h3>
      </div>
      <div class="content">
        <div class='highlight'><pre></pre></div>
      </div>
    </li>
    <li id="section-3">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>We&#39;ll need a Markdown library. Try to load one if not already established.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre><span class="k">unless</span> <span class="n">defined?</span><span class="p">(</span><span class="no">Markdown</span><span class="p">)</span>
  <span class="n">markdown_libraries</span> <span class="o">=</span> <span class="sx">%w[redcarpet rdiscount bluecloth]</span>
  <span class="k">begin</span>
    <span class="nb">require</span> <span class="n">markdown_libraries</span><span class="p">.</span><span class="nf">shift</span>
  <span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">boom</span>
    <span class="k">retry</span> <span class="k">if</span> <span class="n">markdown_libraries</span><span class="p">.</span><span class="nf">any?</span>
    <span class="k">raise</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-4">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>We use <a href="http://defunkt.github.com/mustache/">{{ mustache }}</a> for
HTML templating.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">'mustache'</span></pre></div>
      </div>
    </li>
    <li id="section-5">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Rouge is used for syntax highlighting</p>
      </div>
      <div class="content">
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">'rouge'</span></pre></div>
      </div>
    </li>
    <li id="section-Public_Interface">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Public_Interface">&#182;</a>
        </div>
        <h3>Public Interface</h3>
      </div>
      <div class="content">
        <div class='highlight'><pre></pre></div>
      </div>
    </li>
    <li id="section-7">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p><code>Rocco.new</code> takes a source <code>filename</code>, an optional list of source filenames
for other documentation sources, an <code>options</code> hash, and an optional <code>block</code>.
The <code>options</code> hash respects three members:</p>

<ul>
<li><p><code>:language</code>: specifies which lexer to use if one can&#39;t be
auto-detected from the filename.  <em>Defaults to <code>ruby</code></em>.</p></li>
<li><p><code>:comment_chars</code>, which specifies the comment characters of the
target language. <em>Defaults to <code>#</code></em>.</p></li>
<li><p><code>:template_file</code>, which specifies a external template file to use
when rendering the final, highlighted file via Mustache.  <em>Defaults
to <code>nil</code> (that is, Mustache will use <code>./lib/rocco/layout.mustache</code>)</em>.</p></li>
<li><p><code>:stylesheet</code>, which specifies the css stylesheet to use for each
rendered template.  _Defaults to <code>http://jashkenas.github.com/docco/resources/docco.css</code>
(the original docco stylesheet)</p></li>
</ul>
      </div>
      <div class="content">
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Rocco</span>
  <span class="nc">VERSION</span> <span class="o">=</span> <span class="s1">'0.8.2'</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[],</span> <span class="n">options</span><span class="o">=</span><span class="p">{})</span>
    <span class="vi">@file</span>       <span class="o">=</span> <span class="n">filename</span>
    <span class="vi">@sources</span>    <span class="o">=</span> <span class="n">sources</span>

    <span class="vi">@options</span> <span class="o">=</span>  <span class="p">{</span>
      <span class="ss">:language</span>      <span class="o">=&gt;</span> <span class="no">Rouge</span><span class="o">::</span><span class="no">Lexers</span><span class="o">::</span><span class="no">Ruby</span><span class="p">,</span>
      <span class="ss">:comment_chars</span> <span class="o">=&gt;</span> <span class="s1">'#'</span><span class="p">,</span>
      <span class="ss">:template_file</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span>
      <span class="ss">:encoding</span>      <span class="o">=&gt;</span> <span class="s1">'UTF-8'</span><span class="p">,</span>
      <span class="ss">:stylesheet</span>    <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="s1">'http://jashkenas.github.com/docco/resources/parallel/public/stylesheets/normalize.css'</span><span class="p">,</span>
        <span class="s1">'http://jashkenas.github.com/docco/resources/parallel/docco.css'</span><span class="p">,</span>
        <span class="s1">'http://billiam.github.com/rocco/resources/highlight.css'</span><span class="p">,</span>
      <span class="p">],</span>
      <span class="ss">:markdown_extensions</span> <span class="o">=&gt;</span> <span class="p">[</span>
        <span class="ss">:smart</span><span class="p">,</span>
        <span class="ss">:tables</span><span class="p">,</span>
        <span class="ss">:fenced_code</span>
      <span class="p">]</span>
    <span class="p">}.</span><span class="nf">merge</span><span class="p">(</span><span class="n">options</span><span class="p">)</span></pre></div>
      </div>
    </li>
    <li id="section-8">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>When <code>block</code> is given, it must read the contents of the file using
whatever means necessary and return it as a string. With no <code>block</code>,
the file is read to retrieve data.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="vi">@data</span> <span class="o">=</span> <span class="k">if</span> <span class="nb">block_given?</span>
      <span class="k">yield</span>
    <span class="k">else</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="ss">external_encoding: </span><span class="vi">@options</span><span class="p">[</span><span class="ss">:encoding</span><span class="p">],</span> <span class="ss">internal_encoding: </span><span class="s1">'UTF-8'</span><span class="p">)</span>
    <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-9">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>If we detect a language</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="k">if</span> <span class="n">detect_language</span> <span class="o">!=</span> <span class="no">Rouge</span><span class="o">::</span><span class="no">Lexers</span><span class="o">::</span><span class="no">PlainText</span></pre></div>
      </div>
    </li>
    <li id="section-10">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>then assign the detected language to <code>:language</code>, and look for
comment characters based on that language</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>      <span class="vi">@options</span><span class="p">[</span><span class="ss">:language</span><span class="p">]</span> <span class="o">=</span> <span class="n">detect_language</span></pre></div>
      </div>
    </li>
    <li id="section-11">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>If we didn&#39;t detect a language, but the user provided one, use it
to look around for comment characters to override the default.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="k">elsif</span> <span class="n">options</span><span class="p">[</span><span class="ss">:language</span><span class="p">]</span>
      <span class="vi">@options</span><span class="p">[</span><span class="ss">:language</span><span class="p">]</span> <span class="o">=</span> <span class="n">find_language</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="ss">:language</span><span class="p">])</span>
    <span class="k">end</span>

    <span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">]</span> <span class="o">=</span> <span class="n">generate_comment_chars</span> <span class="n">options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">]</span></pre></div>
      </div>
    </li>
    <li id="section-12">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Turn <code>:comment_chars</code> into a regex matching a series of spaces, the
<code>:comment_chars</code> string, and the an optional space.  We&#39;ll use that
to detect single-line comments.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="vi">@comment_pattern</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"^</span><span class="se">\\</span><span class="s2">s*</span><span class="si">#{</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:single</span><span class="p">]</span><span class="si">}</span><span class="se">\s</span><span class="s2">?"</span><span class="p">)</span></pre></div>
      </div>
    </li>
    <li id="section-13">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p><code>parse()</code> the file contents stored in <code>@data</code>.  Run the result through
<code>split()</code> and that result through <code>highlight()</code> to generate the final
section list.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="vi">@sections</span> <span class="o">=</span> <span class="n">highlight</span><span class="p">(</span><span class="nb">split</span><span class="p">(</span><span class="n">parse</span><span class="p">(</span><span class="vi">@data</span><span class="p">)))</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-14">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>The filename as given to <code>Rocco.new</code>.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="kp">attr_reader</span> <span class="ss">:file</span></pre></div>
      </div>
    </li>
    <li id="section-15">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>The merged options array</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="kp">attr_reader</span> <span class="ss">:options</span></pre></div>
      </div>
    </li>
    <li id="section-16">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>A list of two-tuples representing each <em>section</em> of the source file. Each
item in the list has the form: <code>[docs_html, code_html]</code>, where both
elements are strings containing the documentation and source code HTML,
respectively.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="kp">attr_reader</span> <span class="ss">:sections</span></pre></div>
      </div>
    </li>
    <li id="section-17">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>A list of all source filenames included in the documentation set. Useful
for building an index of other files.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="kp">attr_reader</span> <span class="ss">:sources</span></pre></div>
      </div>
    </li>
    <li id="section-18">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Generate HTML output for the entire document.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="nb">require</span> <span class="s1">'rocco/layout'</span>
  <span class="k">def</span> <span class="nf">to_html</span>
    <span class="no">Rocco</span><span class="o">::</span><span class="no">Layout</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:stylesheet</span><span class="p">],</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:template_file</span><span class="p">]).</span><span class="nf">render</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">find_language</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
     <span class="no">Rouge</span><span class="o">::</span><span class="no">Lexer</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">||</span> <span class="k">raise</span><span class="p">(</span><span class="s2">"Invalid language requested: </span><span class="si">#{</span><span class="n">tag</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-Helper_Functions">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Helper_Functions">&#182;</a>
        </div>
        <h2>Helper Functions</h2>
      </div>
      <div class="content">
        <div class='highlight'><pre></pre></div>
      </div>
    </li>
    <li id="section-20">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Autodetect file language by filename and content (if possible).
We&#39;ll memoize the result, as we&#39;ll call this a few times.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">detect_language</span>
    <span class="vi">@_language</span> <span class="o">||=</span> <span class="k">begin</span>
      <span class="n">opts</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">filename: </span><span class="vi">@file</span> <span class="p">}</span>

      <span class="k">if</span> <span class="no">File</span><span class="p">.</span><span class="nf">readable?</span><span class="p">(</span><span class="vi">@file</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="no">File</span><span class="p">.</span><span class="nf">file?</span><span class="p">(</span><span class="vi">@file</span><span class="p">)</span>
        <span class="n">opts</span><span class="p">[</span><span class="ss">:source</span><span class="p">]</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="vi">@file</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="no">Rouge</span><span class="o">::</span><span class="no">Lexer</span><span class="p">.</span><span class="nf">guess</span><span class="p">(</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-21">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Given a file&#39;s language, we should be able to autopopulate the
<code>comment_chars</code> variables for single-line comments.  If we don&#39;t
have comment characters on record for a given language, we&#39;ll
use the user-provided <code>:comment_char</code> option (which defaults to
<code>#</code>).</p>

<p>Comment characters are listed as:</p>

<pre><code>{ :single       =&gt; &quot;//&quot;,
  :multi_start  =&gt; &quot;/**&quot;,
  :multi_middle =&gt; &quot;*&quot;,
  :multi_end    =&gt; &quot;*/&quot; }
</code></pre>

<p><code>:single</code> denotes the leading character of a single-line comment.
<code>:multi_start</code> denotes the string that should appear alone on a
line of code to begin a block of documentation.  <code>:multi_middle</code>
denotes the leading character of block comment content, and
<code>:multi_end</code> is the string that ought appear alone on a line to
close a block of documentation.  That is:</p>

<pre><code>/**                 [:multi][:start]
 *                  [:multi][:middle]
 ...
 *                  [:multi][:middle]
 */                 [:multi][:end]
</code></pre>

<p>If a language only has one type of comment, the missing type
should be assigned <code>nil</code>.</p>

<p>At the moment, we&#39;re only returning <code>:single</code>.  Consider this
groundwork for block comment parsing.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="nb">require</span> <span class="s1">'rocco/comment_styles'</span>
  <span class="kp">include</span> <span class="no">CommentStyles</span>

  <span class="k">def</span> <span class="nf">generate_comment_chars</span> <span class="n">override_chars</span>
    <span class="vi">@_commentchar</span> <span class="o">||=</span> <span class="k">if</span> <span class="n">override_chars</span>
      <span class="p">{</span> <span class="ss">:single</span> <span class="o">=&gt;</span> <span class="n">override_chars</span><span class="p">,</span> <span class="ss">:multi</span> <span class="o">=&gt;</span> <span class="kp">nil</span><span class="p">,</span> <span class="ss">:heredoc</span> <span class="o">=&gt;</span> <span class="kp">nil</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="no">COMMENT_STYLES</span><span class="p">[</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:language</span><span class="p">].</span><span class="nf">tag</span><span class="p">]</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-Internal_Parsing_and_Highlighting">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Internal_Parsing_and_Highlighting">&#182;</a>
        </div>
        <h2>Internal Parsing and Highlighting</h2>
      </div>
      <div class="content">
        <div class='highlight'><pre></pre></div>
      </div>
    </li>
    <li id="section-23">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>Parse the raw file data into a list of two-tuples. Each tuple has the
form <code>[docs, code]</code> where both elements are arrays containing the
raw lines parsed from the input file, comment characters stripped.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">sections</span><span class="p">,</span> <span class="n">docs</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span></pre></div>
      </div>
    </li>
    <li id="section-24">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>The first line is ignored if it is a shebang line.  We also ignore the
PEP 263 encoding information in python sourcefiles, and the similar ruby
1.9 syntax.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="n">lines</span><span class="p">.</span><span class="nf">shift</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">/^\#\!/</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">shift</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=~</span> <span class="sr">/coding[:=]\s*[-\w.]+/</span> <span class="o">&amp;&amp;</span>
                   <span class="p">[</span> <span class="s2">"python"</span><span class="p">,</span> <span class="s2">"ruby"</span> <span class="p">].</span><span class="nf">include?</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:language</span><span class="p">].</span><span class="nf">tag</span><span class="p">)</span></pre></div>
      </div>
    </li>
    <li id="section-25">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>To detect both block comments and single-line comments, we&#39;ll set
up a tiny state machine, and loop through each line of the file.
This requires an <code>in_comment_block</code> boolean, and a few regular
expressions for line tests.  We&#39;ll do the same for fake heredoc parsing.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="n">in_comment_block</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="n">in_heredoc</span> <span class="o">=</span> <span class="kp">false</span>
    <span class="n">single_line_comment</span><span class="p">,</span> <span class="n">block_comment_start</span><span class="p">,</span> <span class="n">block_comment_mid</span><span class="p">,</span> <span class="n">block_comment_end</span> <span class="o">=</span>
      <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span>
    <span class="k">if</span> <span class="n">not</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:single</span><span class="p">].</span><span class="nf">nil?</span>
      <span class="n">single_line_comment</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"^</span><span class="se">\\</span><span class="s2">s*</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:single</span><span class="p">])</span><span class="si">}</span><span class="se">\\</span><span class="s2">s?"</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="n">not</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">].</span><span class="nf">nil?</span>
      <span class="n">block_comment_start</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"^</span><span class="se">\\</span><span class="s2">s*</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:start</span><span class="p">])</span><span class="si">}</span><span class="se">\\</span><span class="s2">s*$"</span><span class="p">)</span>
      <span class="n">block_comment_end</span>   <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"^</span><span class="se">\\</span><span class="s2">s*</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:end</span><span class="p">])</span><span class="si">}</span><span class="se">\\</span><span class="s2">s*$"</span><span class="p">)</span>
      <span class="n">block_comment_one_liner</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"^</span><span class="se">\\</span><span class="s2">s*</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:start</span><span class="p">])</span><span class="si">}</span><span class="se">\\</span><span class="s2">s*(.*?)</span><span class="se">\\</span><span class="s2">s*</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:end</span><span class="p">])</span><span class="si">}</span><span class="se">\\</span><span class="s2">s*$"</span><span class="p">)</span>
      <span class="n">block_comment_start_with</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"^</span><span class="se">\\</span><span class="s2">s*</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:start</span><span class="p">])</span><span class="si">}</span><span class="se">\\</span><span class="s2">s*(.*?)$"</span><span class="p">)</span>
      <span class="n">block_comment_end_with</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"</span><span class="se">\\</span><span class="s2">s*(.*?)</span><span class="se">\\</span><span class="s2">s*</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:end</span><span class="p">])</span><span class="si">}</span><span class="se">\\</span><span class="s2">s*$"</span><span class="p">)</span>
      <span class="k">if</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:middle</span><span class="p">]</span>
        <span class="n">block_comment_mid</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"^</span><span class="se">\\</span><span class="s2">s*</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:middle</span><span class="p">])</span><span class="si">}</span><span class="se">\\</span><span class="s2">s?"</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="n">not</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:heredoc</span><span class="p">].</span><span class="nf">nil?</span>
      <span class="n">heredoc_start</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:heredoc</span><span class="p">])</span><span class="si">}</span><span class="s2">(</span><span class="se">\\</span><span class="s2">S+)$"</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">lines</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span></pre></div>
      </div>
    </li>
    <li id="section-26">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>If we&#39;re currently in a comment block, check whether the line matches
the <em>end</em> of a comment block or the <em>end</em> of a comment block with a
comment.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>      <span class="k">if</span> <span class="n">in_comment_block</span>
        <span class="k">if</span> <span class="n">block_comment_end</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">block_comment_end</span><span class="p">)</span>
          <span class="n">in_comment_block</span> <span class="o">=</span> <span class="kp">false</span>
        <span class="k">elsif</span> <span class="n">block_comment_end_with</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">block_comment_end_with</span><span class="p">)</span>
          <span class="n">in_comment_block</span> <span class="o">=</span> <span class="kp">false</span>
          <span class="n">docs</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">block_comment_end_with</span><span class="p">).</span><span class="nf">captures</span><span class="p">.</span><span class="nf">first</span><span class="p">.</span>
                        <span class="nf">sub</span><span class="p">(</span><span class="n">block_comment_mid</span> <span class="o">||</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">docs</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="n">block_comment_mid</span> <span class="o">||</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-27">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>If we&#39;re currently in a heredoc, we&#39;re looking for the end of the
heredoc, and everything it contains is code.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>      <span class="k">elsif</span> <span class="n">in_heredoc</span>
        <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"^</span><span class="si">#{</span><span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="n">in_heredoc</span><span class="p">)</span><span class="si">}</span><span class="s2">$"</span><span class="p">))</span>
          <span class="n">in_heredoc</span> <span class="o">=</span> <span class="kp">false</span>
        <span class="k">end</span>
        <span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="n">line</span></pre></div>
      </div>
    </li>
    <li id="section-28">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>Otherwise, check whether the line starts a heredoc. If so, note the end
pattern, and the line is code.  Otherwise check whether the line matches
the beginning of a block, or a single-line comment all on it&#39;s lonesome.
In either case, if there&#39;s code, start a new section.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>      <span class="k">else</span>
        <span class="k">if</span> <span class="n">heredoc_start</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">heredoc_start</span><span class="p">)</span>
          <span class="n">in_heredoc</span> <span class="o">=</span> <span class="vg">$1</span>
          <span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
        <span class="k">elsif</span> <span class="n">block_comment_one_liner</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">block_comment_one_liner</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">code</span><span class="p">.</span><span class="nf">any?</span>
            <span class="n">sections</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="n">docs</span><span class="p">,</span> <span class="n">code</span><span class="p">]</span>
            <span class="n">docs</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
          <span class="k">end</span>
          <span class="n">docs</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">block_comment_one_liner</span><span class="p">).</span><span class="nf">captures</span><span class="p">.</span><span class="nf">first</span>
        <span class="k">elsif</span> <span class="n">block_comment_start</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">block_comment_start</span><span class="p">)</span>
          <span class="n">in_comment_block</span> <span class="o">=</span> <span class="kp">true</span>
          <span class="k">if</span> <span class="n">code</span><span class="p">.</span><span class="nf">any?</span>
            <span class="n">sections</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="n">docs</span><span class="p">,</span> <span class="n">code</span><span class="p">]</span>
            <span class="n">docs</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
          <span class="k">end</span>
        <span class="k">elsif</span> <span class="n">block_comment_start_with</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">block_comment_start_with</span><span class="p">)</span>
          <span class="n">in_comment_block</span> <span class="o">=</span> <span class="kp">true</span>
          <span class="k">if</span> <span class="n">code</span><span class="p">.</span><span class="nf">any?</span>
            <span class="n">sections</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="n">docs</span><span class="p">,</span> <span class="n">code</span><span class="p">]</span>
            <span class="n">docs</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
          <span class="k">end</span>
          <span class="n">docs</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">block_comment_start_with</span><span class="p">).</span><span class="nf">captures</span><span class="p">.</span><span class="nf">first</span>
        <span class="k">elsif</span> <span class="n">single_line_comment</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="n">single_line_comment</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">code</span><span class="p">.</span><span class="nf">any?</span>
            <span class="n">sections</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="n">docs</span><span class="p">,</span> <span class="n">code</span><span class="p">]</span>
            <span class="n">docs</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
          <span class="k">end</span>
          <span class="n">docs</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="n">single_line_comment</span> <span class="o">||</span> <span class="s1">''</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="n">sections</span> <span class="o">&lt;&lt;</span> <span class="p">[</span><span class="n">docs</span><span class="p">,</span> <span class="n">code</span><span class="p">]</span> <span class="k">if</span> <span class="n">docs</span><span class="p">.</span><span class="nf">any?</span> <span class="o">||</span> <span class="n">code</span><span class="p">.</span><span class="nf">any?</span>
    <span class="n">normalize_leading_spaces</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-29">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>Normalizes documentation whitespace by checking for leading whitespace,
removing it, and then removing the same amount of whitespace from each
succeeding line.  That is:</p>

<pre><code>def func():
  &quot;&quot;&quot;
    Comment 1
    Comment 2
  &quot;&quot;&quot;
  print &quot;omg!&quot;
</code></pre>

<p>should yield a comment block of <code>Comment 1\nComment 2</code> and code of
<code>def func():\n  print &quot;omg!&quot;</code></p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">normalize_leading_spaces</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
    <span class="n">sections</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">section</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">section</span><span class="p">.</span><span class="nf">any?</span> <span class="o">&amp;&amp;</span> <span class="n">section</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">any?</span>
        <span class="n">leading_space</span> <span class="o">=</span> <span class="n">section</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nf">match</span><span class="p">(</span><span class="s2">"^</span><span class="se">\s</span><span class="s2">+"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">leading_space</span>
          <span class="n">section</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
            <span class="n">section</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">map</span><span class="p">{</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="n">line</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sr">/^</span><span class="si">#{</span><span class="n">leading_space</span><span class="p">.</span><span class="nf">to_s</span><span class="si">}</span><span class="sr">/</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="n">section</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-30">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>Take the list of paired <em>sections</em> two-tuples and split into two
separate lists: one holding the comments with leaders removed and
one with the code blocks.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="n">sections</span><span class="p">)</span>
    <span class="n">docs_blocks</span><span class="p">,</span> <span class="n">code_blocks</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">sections</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">docs</span><span class="p">,</span><span class="n">code</span><span class="o">|</span>
      <span class="n">docs_blocks</span> <span class="o">&lt;&lt;</span> <span class="n">docs</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
      <span class="n">code_blocks</span> <span class="o">&lt;&lt;</span> <span class="n">code</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
        <span class="n">tabs</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/^(\t+)/</span><span class="p">)</span>
        <span class="n">tabs</span> <span class="p">?</span> <span class="n">line</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sr">/^\t+/</span><span class="p">,</span> <span class="s1">'  '</span> <span class="o">*</span> <span class="n">tabs</span><span class="p">.</span><span class="nf">captures</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">length</span><span class="p">)</span> <span class="p">:</span> <span class="n">line</span>
      <span class="k">end</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="p">[</span><span class="n">docs_blocks</span><span class="p">,</span> <span class="n">code_blocks</span><span class="p">]</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-31">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>Take a list of block comments and convert Docblock @annotations to
Markdown syntax.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">docblock</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span>
    <span class="n">docs</span><span class="p">.</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">doc</span><span class="o">|</span>
      <span class="n">doc</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">).</span><span class="nf">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
        <span class="n">line</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="sr">/^@\w+/</span><span class="p">)</span> <span class="p">?</span> <span class="n">line</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sr">/^@(\w+)\s+/</span><span class="p">,</span> <span class="s1">'&gt; **\1** '</span><span class="p">)</span><span class="o">+</span><span class="s2">"  "</span> <span class="p">:</span> <span class="n">line</span>
      <span class="k">end</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-32">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>Take the result of <code>split</code> and apply Markdown formatting to comments and
syntax highlighting to source code.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">highlight</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
    <span class="n">docs_blocks</span><span class="p">,</span> <span class="n">code_blocks</span> <span class="o">=</span> <span class="n">blocks</span></pre></div>
      </div>
    </li>
    <li id="section-33">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>Pre-process Docblock @annotations.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="n">docs_blocks</span> <span class="o">=</span> <span class="n">docblock</span><span class="p">(</span><span class="n">docs_blocks</span><span class="p">)</span> <span class="k">if</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:docblocks</span><span class="p">]</span></pre></div>
      </div>
    </li>
    <li id="section-34">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>Combine all docs blocks into a single big markdown document with section
dividers and run through the Markdown processor. Then split it back out
into separate sections.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="n">markdown</span> <span class="o">=</span> <span class="n">docs_blocks</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">"</span><span class="se">\n\n</span><span class="s2">##### DIVIDER</span><span class="se">\n\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">docs_html</span> <span class="o">=</span> <span class="n">process_markdown</span><span class="p">(</span><span class="n">markdown</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sr">/\n*&lt;h5&gt;DIVIDER&lt;\/h5&gt;\n*/m</span><span class="p">)</span>
    <span class="n">docs_html</span> <span class="o">&lt;&lt;</span> <span class="s2">""</span> <span class="k">if</span> <span class="n">docs_html</span><span class="p">.</span><span class="nf">empty?</span></pre></div>
      </div>
    </li>
    <li id="section-35">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>Combine all code blocks into a single big stream with section dividers and
run through rouge</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="n">span</span><span class="p">,</span> <span class="n">espan</span> <span class="o">=</span> <span class="s1">'&lt;span class="c.?"&gt;'</span><span class="p">,</span> <span class="s1">'&lt;/span&gt;'</span>
    <span class="k">if</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:single</span><span class="p">]</span>
      <span class="n">front</span> <span class="o">=</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:single</span><span class="p">]</span>
      <span class="n">divider_input</span>  <span class="o">=</span> <span class="s2">"</span><span class="se">\n\n</span><span class="si">#{</span><span class="n">front</span><span class="si">}</span><span class="s2"> DIVIDER</span><span class="se">\n\n</span><span class="s2">"</span>
      <span class="n">divider_output</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
        <span class="p">[</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">n*"</span><span class="p">,</span>
          <span class="n">span</span><span class="p">,</span>
          <span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="no">CGI</span><span class="p">.</span><span class="nf">escapeHTML</span><span class="p">(</span><span class="n">front</span><span class="p">)),</span>
          <span class="s1">' DIVIDER'</span><span class="p">,</span>
          <span class="n">espan</span><span class="p">,</span>
          <span class="s2">"</span><span class="se">\\</span><span class="s2">n*"</span>
        <span class="p">].</span><span class="nf">join</span><span class="p">,</span> <span class="no">Regexp</span><span class="o">::</span><span class="no">MULTILINE</span>
      <span class="p">)</span>
    <span class="k">else</span>
      <span class="n">front</span> <span class="o">=</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:start</span><span class="p">]</span>
      <span class="n">back</span>  <span class="o">=</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:comment_chars</span><span class="p">][</span><span class="ss">:multi</span><span class="p">][</span><span class="ss">:end</span><span class="p">]</span>
      <span class="n">divider_input</span>  <span class="o">=</span> <span class="s2">"</span><span class="se">\n\n</span><span class="si">#{</span><span class="n">front</span><span class="si">}</span><span class="se">\n</span><span class="s2">DIVIDER</span><span class="se">\n</span><span class="si">#{</span><span class="n">back</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">"</span>
      <span class="n">divider_output</span> <span class="o">=</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
        <span class="p">[</span> <span class="s2">"</span><span class="se">\\</span><span class="s2">n*"</span><span class="p">,</span>
          <span class="n">span</span><span class="p">,</span> <span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="no">CGI</span><span class="p">.</span><span class="nf">escapeHTML</span><span class="p">(</span><span class="n">front</span><span class="p">)),</span>
          <span class="s2">"</span><span class="se">\\</span><span class="s2">n"</span><span class="p">,</span>
          <span class="s2">"DIVIDER"</span><span class="p">,</span>
          <span class="s2">"</span><span class="se">\\</span><span class="s2">n"</span><span class="p">,</span>
          <span class="no">Regexp</span><span class="p">.</span><span class="nf">escape</span><span class="p">(</span><span class="no">CGI</span><span class="p">.</span><span class="nf">escapeHTML</span><span class="p">(</span><span class="n">back</span><span class="p">)),</span> <span class="n">espan</span><span class="p">,</span>
          <span class="s2">"</span><span class="se">\\</span><span class="s2">n*"</span>
        <span class="p">].</span><span class="nf">join</span><span class="p">,</span> <span class="no">Regexp</span><span class="o">::</span><span class="no">MULTILINE</span>
      <span class="p">)</span>
    <span class="k">end</span>

    <span class="n">code_stream</span> <span class="o">=</span> <span class="n">code_blocks</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">divider_input</span><span class="p">)</span>

    <span class="n">code_html</span> <span class="o">=</span> <span class="n">syntax_highlight</span><span class="p">(</span><span class="n">code_stream</span><span class="p">)</span></pre></div>
      </div>
    </li>
    <li id="section-36">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>Do some post-processing on the output to split things back
into sections and remove partial <code>&lt;pre&gt;</code> blocks.
unless code<em>html == &#39;&#39;
  # raise @options.inspect
  raise divider</em>output.inspect
  raise code_html
end</p>
      </div>
      <div class="content">
        <div class='highlight'><pre></pre></div>
      </div>
    </li>
    <li id="section-37">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>raise divider_output.inspect</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="n">code_html</span> <span class="o">=</span> <span class="n">code_html</span><span class="p">.</span>
      <span class="nf">split</span><span class="p">(</span><span class="n">divider_output</span><span class="p">).</span>
      <span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">code</span><span class="o">|</span> <span class="n">code</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sr">/\n?&lt;div class="highlight"&gt;&lt;pre&gt;/m</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="p">}.</span>
      <span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">code</span><span class="o">|</span> <span class="n">code</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="sr">/\n?&lt;\/pre&gt;&lt;\/div&gt;\n/m</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span> <span class="p">}</span></pre></div>
      </div>
    </li>
    <li id="section-38">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>Lastly, combine the docs and code lists back into a list of two-tuples.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>    <span class="n">docs_html</span><span class="p">.</span><span class="nf">zip</span><span class="p">(</span><span class="n">code_html</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-39">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>Convert Markdown to classy HTML.</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">process_markdown</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="no">Markdown</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="o">*</span><span class="vi">@options</span><span class="p">[</span><span class="ss">:markdown_extensions</span><span class="p">]).</span><span class="nf">to_html</span>
  <span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-40">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>Hand off syntax highlighting to Rouge</p>
      </div>
      <div class="content">
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">syntax_highlight</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">formatter</span> <span class="o">=</span> <span class="no">Rouge</span><span class="o">::</span><span class="no">Formatters</span><span class="o">::</span><span class="no">HTML</span><span class="p">.</span><span class="nf">new</span> <span class="n">wrap</span><span class="ss">:false</span>
    <span class="n">lexer</span> <span class="o">=</span> <span class="vi">@options</span><span class="p">[</span><span class="ss">:language</span><span class="p">].</span><span class="nf">new</span>

    <span class="n">formatter</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">lexer</span><span class="p">.</span><span class="nf">lex</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </div>
    </li>
    <li id="section-41">
      <div class="annotation">
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>And that&#39;s it.</p>

      </div>
      <div class="content">
        <div class='highlight'><pre></pre></div>
      </div>
    </li>
  </ul>
  </div>
    <script type="text/javascript" src="http://billiam.github.com/rocco/resources/docco.js"></script>
</body>
</html>